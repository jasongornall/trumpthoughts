// Generated by CoffeeScript 1.8.0
var config, loginPopup, msnry, response_type, _fn, _i, _len, _ref;

msnry = null;

config = {
  apiKey: "AIzaSyBmPkme_3537O_YbLRlq27PiFMOtNi4vP4",
  authDomain: "trump-64059.firebaseapp.com",
  databaseURL: "https://trump-64059.firebaseio.com",
  storageBucket: "trump-64059.appspot.com",
  messagingSenderId: "57700495171"
};

firebase.initializeApp(config);

firebase.auth().onAuthStateChanged(function(user) {
  if (user) {
    window.logged_in = user;
    return $('body > #auth').html(teacup.render(function() {
      return div('.btn', function() {
        span(function() {
          return "logged in as: ";
        });
        img({
          src: user.photoURL
        });
        return span(function() {
          return " " + user.displayName;
        });
      });
    }));
  } else {
    return window.logged_in = false;
  }
});

loginPopup = function() {
  $('body #popups').append(teacup.render(function() {
    return div('.modalDialog submit', function() {
      return div('.wrapper', function() {
        span('.close', function() {
          return 'x';
        });
        h3(function() {
          return 'Login to add your content';
        });
        return div('.navigation', function() {
          span('.option', {
            'data-option': 'google'
          }, function() {
            img({
              src: 'https://www.gstatic.com/mobilesdk/160512_mobilesdk/auth_service_google.svg'
            });
            return span(function() {
              return 'Google';
            });
          });
          span('.option', {
            'data-option': 'facebook'
          }, function() {
            img({
              src: 'https://www.gstatic.com/mobilesdk/160409_mobilesdk/images/auth_service_facebook.svg'
            });
            return span(function() {
              return 'Facebook';
            });
          });
          return span('.option', {
            'data-option': 'twitter'
          }, function() {
            img({
              src: 'https://www.gstatic.com/mobilesdk/160409_mobilesdk/images/auth_service_twitter.svg'
            });
            return span(function() {
              return 'Twitter';
            });
          });
        });
      });
    });
  }));
  $('.modalDialog.submit').fadeIn();
  $('.modalDialog.submit .close').on('click', function(e) {
    var $el;
    return $el = $(e.currentTarget).closest('.modalDialog').fadeOut('slow', function() {
      return $(this).remove();
    });
  });
  return $('.modalDialog.submit [data-option]').on('click', function(e) {
    var $el, provider;
    $el = $(e.currentTarget);
    switch ($el.data('option')) {
      case 'google':
        provider = new firebase.auth.GoogleAuthProvider();
        return firebase.auth().signInWithPopup(provider).then(function(result) {
          var token, user;
          token = result.credential.accessToken;
          user = result.user;
          return finishLogin(token, user);
        })["catch"](function(error) {
          if (error) {
            return console.log(error);
          }
        });
    }
  });
};

$('.submit').on('click', function(e) {
  var $el, ref, trump_letter, type;
  $el = $(e.currentTarget);
  type = $el.data('type');
  if (window.logged_in) {
    trump_letter = $('#trump-letter').val();
    ref = firebase.database().ref(type).push();
    ref.set({
      letter: trump_letter,
      time: firebase.database.ServerValue.TIMESTAMP
    });
    return firebase.database().ref("users/" + window.logged_in.uid + "/letters").push({
      letter: trump_letter,
      location: ref.toString()
    });
  } else {
    return loginPopup();
  }
});

_ref = ['negative', 'positive'];
_fn = function(response_type) {
  return firebase.database().ref(response_type).on('child_added', function(snapshot) {
    return $("#" + response_type).append(teacup.render(function() {
      return div(".response " + response_type, {
        'data': {
          key: snapshot.key,
          time: snapshot.child('time').val()
        }
      }, function() {
        return div('.body', function() {
          return snapshot.child('letter').val();
        });
      });
    }));
  });
};
for (_i = 0, _len = _ref.length; _i < _len; _i++) {
  response_type = _ref[_i];
  _fn(response_type);
}
